


<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>DOMO Embed with Tracking + Filter Button</title>
  <style>
    body { margin: 0; font-family: system-ui, sans-serif; background: #f7f7f8; }
    #log { background: #222; color: #0f0; padding: 10px; font: 14px/1.4 monospace; border-bottom: 2px solid #555; max-height: 220px; overflow-y: auto; }
    #status { background: #fff; padding: 10px 12px; border-bottom: 1px solid #ddd; font-size: 14px; }
    iframe { display: block; margin: 16px auto; border: 1px solid #ccc; border-radius: 8px; box-shadow: 0 6px 18px rgba(0,0,0,.1); }
    .muted { color: #666; }

    .controls {
      max-width: 1200px;
      margin: 16px auto 0;
      text-align: center;
    }
    #updateBtn {
      padding: 10px 16px; border: 0; border-radius: 10px;
      background: #0d6efd; color: #fff; font-weight: 600; cursor: pointer;
      box-shadow: 0 4px 10px rgba(13,110,253,0.25);
    }
    #updateBtn:hover { filter: brightness(1.05); }
  </style>
</head>
<body>
  <!-- Status strip -->
  <div id="status">
    <strong>Current:</strong>
    <span id="curSrc" class="muted">â€”</span>
    <span id="curLevel" class="muted"></span>
    <div id="curFilters" class="muted">Waiting for URL change or postMessageâ€¦</div>
  </div>

  <!-- Terminal-like log -->
  <div id="log">[Tracking log will appear here]</div>

  <!-- Controls -->
  <div class="controls">
    <button id="updateBtn">Filter</button>
  </div>

  <!-- The DOMO iframe -->
  <iframe
    id="domoFrame"
    src="https://embed.domo.com/embed/pages/qQLW0"
    width="1248" height="1620" frameborder="0">
  </iframe>

  <script>
    const frame = document.getElementById('domoFrame');
    const logBox = document.getElementById('log');
    const curSrc = document.getElementById('curSrc');
    const curLevel = document.getElementById('curLevel');
    const curFilters = document.getElementById('curFilters');
    const updateBtn = document.getElementById('updateBtn');

    // ðŸ”’ Hidden long URL
    
    const FILTER_URL = "https://embed.domo.com/embed/pages/x68r9?pfilters=%5B%7B%22column%22%3A%22LFT_REGION%22%2C%22dataSourceID%22%3A%22dataset0%22%2C%22dataType%22%3A%22string%22%2C%22operand%22%3A%22IN%22%2C%22values%22%3A%5B%22Europe%2FFSU%22%5D%7D%2C%7B%22column%22%3A%22LFT_CATEGORY%22%2C%22dataSourceID%22%3A%22dataset0%22%2C%22dataType%22%3A%22string%22%2C%22operand%22%3A%22IN%22%2C%22values%22%3A%5B%22Hard%22%5D%7D%2C%7B%22column%22%3A%22LFT_SUBCATEGORY%22%2C%22dataSourceID%22%3A%22dataset0%22%2C%22dataType%22%3A%22string%22%2C%22operand%22%3A%22IN%22%2C%22values%22%3A%5B%22Legal%20Risk%22%5D%7D%5D";

    const state = { src: null, filtersJson: null, level: null };

    function log(msg, data) {
      const line = `[${new Date().toLocaleTimeString()}] ${msg}` + (data ? ' ' + JSON.stringify(data) : '');
      console.log(line);
      logBox.textContent = line + "\n" + logBox.textContent;
    }

    function decodePfilters(url) {
      try {
        const u = new URL(url);
        const pf = u.searchParams.get('pfilters');
        if (!pf) return null;
        return JSON.parse(decodeURIComponent(pf));
      } catch { return null; }
    }

    function inferLevel(filters) {
      if (!filters || !filters.length) return 'world';
      const hasJur = filters.some(f => f.column === 'LFT_JURISDICTION' && f.values?.length);
      const hasReg = filters.some(f => f.column === 'LFT_REGION' && f.values?.length);
      if (hasJur) return 'jurisdiction';
      if (hasReg) return 'region';
      return 'world';
    }

    function renderStatus(src, filters) {
      curSrc.textContent = src || 'â€”';
      const lvl = inferLevel(filters);
      curLevel.textContent = ` | Level: ${lvl}`;
      curFilters.textContent = filters ? JSON.stringify(filters) : '(no pfilters in URL)';
      state.level = lvl;
    }

    function updateFromSrc(tag) {
      const src = frame.src;
      const filters = decodePfilters(src);
      const filtersJson = filters ? JSON.stringify(filters) : null;

      if (state.src === src && state.filtersJson === filtersJson) return;

      state.src = src;
      state.filtersJson = filtersJson;
      renderStatus(src, filters);
      log(tag, { src, pfilters: filters });
    }

    // On iframe load
    frame.addEventListener('load', () => updateFromSrc('iframe loaded'));

    // Watch for iframe src changes
    new MutationObserver(muts => {
      for (const m of muts) {
        if (m.type === 'attributes' && m.attributeName === 'src') {
          updateFromSrc('iframe src changed');
        }
      }
    }).observe(frame, { attributes: true, attributeFilter: ['src'] });

    // Listen for postMessages from Domo brick
    window.addEventListener('message', (e) => {
      if (!e.data || e.data.type !== 'domo:navigate') return;
      const payload = e.data.payload || {};
      curSrc.textContent = state.src || '(src unchanged)';
      curLevel.textContent = ` | Level: ${payload.level || 'unknown'}`;
      curFilters.textContent = payload.pfilters ? JSON.stringify(payload.pfilters) : '(no pfilters in message)';
      log('Domo state via postMessage', payload);
    });

    // Button action
    updateBtn.addEventListener('click', () => {
      log('button: setting iframe src', { src: FILTER_URL });
      frame.src = FILTER_URL;
    });
  </script>
</body>
</html>
